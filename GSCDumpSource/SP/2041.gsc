// IW8 GSC SOURCE
// Generated by https://github.com/xensik/gsc-tool

main()
{
    if ( !isdefined( level.stealth ) )
        scripts\stealth\manager::main();

    init_settings();
    thread spotted_thread();
    thread visibility_thread();
}

init_settings()
{
    self.stealth = spawnstruct();
    self.stealth.spotted_list = [];
    self.stealth.funcs = [];
    scripts\engine\utility::ent_flag_init( "stealth_enabled" );
    scripts\engine\utility::ent_flag_init( "stealth_override_goal" );
    scripts\engine\utility::ent_flag_set( "stealth_enabled" );
    scripts\engine\utility::ent_flag_init( "stealth_in_shadow" );
    scripts\stealth\utility::group_flag_init( "stealth_spotted" );
    scripts\stealth\utility::group_add();
    self.stealth.bsmstate = 0;
}

spotted_thread()
{
    self endon( "death" );
    self notify( "spotted_thread" );
    self endon( "spotted_thread" );

    for (;;)
    {
        scripts\engine\utility::ent_flag_wait( "stealth_enabled" );
        scripts\stealth\utility::group_flag_waitopen( "stealth_spotted" );

        if ( !scripts\engine\utility::ent_flag( "stealth_enabled" ) )
            scripts\engine\utility::ent_flag_wait( "stealth_enabled" );

        thread state_hidden();
        scripts\engine\utility::ent_flag_wait( "stealth_enabled" );
        scripts\stealth\utility::group_flag_wait( "stealth_spotted" );

        if ( !scripts\engine\utility::ent_flag( "stealth_enabled" ) )
            scripts\engine\utility::ent_flag_wait( "stealth_enabled" );

        thread state_spotted();
    }
}

state_hidden()
{
    thread scripts\stealth\utility::setbattlechatter( 0 );
    self.stealth.oldgrenadeammo = self.grenadeammo;
    self.grenadeammo = 0;
    self.forcesidearm = 0;
    self.dontevershoot = 1;
    self.dontattackme = 1;

    if ( isdefined( self.stealth.funcs["hidden"] ) )
        scripts\stealth\callbacks::stealth_call_thread( "hidden" );
}

state_spotted()
{
    thread scripts\stealth\utility::setbattlechatter( 1 );

    if ( isdefined( self.stealth.oldgrenadeammo ) )
        self.grenadeammo = self.stealth.oldgrenadeammo;
    else
        self.grenadeammo = 3;

    self.dontevershoot = 0;
    self.dontattackme = 0;
    self pushplayer( 0 );

    if ( isdefined( self.stealth.funcs["spotted"] ) )
        scripts\stealth\callbacks::stealth_call_thread( "spotted" );
}

getup_from_prone()
{
    self endon( "death" );
}

visibility_thread()
{
    self endon( "death" );
    self endon( "long_death" );

    for (;;)
    {
        scripts\engine\utility::ent_flag_wait( "stealth_enabled" );

        if ( !isdefined( self.stealth.ignore_visibility ) )
            self.maxvisibledist = get_detect_range();

        wait 0.05;
    }
}

get_detect_range()
{
    var_0 = self.currentpose;

    if ( var_0 == "back" )
        var_0 = "prone";

    if ( scripts\stealth\utility::group_spotted_flag() )
        var_1 = "spotted";
    else
        var_1 = "hidden";

    var_2 = level.stealth.detect.range[var_1][var_0];

    if ( scripts\engine\utility::ent_flag( "stealth_in_shadow" ) )
        var_2 = max( level.stealth.detect.range["hidden"]["prone"], var_2 * 0.5 );

    return var_2;
}
